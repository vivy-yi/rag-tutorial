# 模块2练习题集 - 核心优化技术

> 通过实践巩固所学知识，完成从理论到应用的跨越！

---

## 📋 练习题概览

**总题数**：50道
- 基础练习：30道
- 进阶练习：15道
- 挑战项目：5道

**预计时间**：8-12小时
**难度等级**：⭐⭐⭐⭐☆

---

## 第6章：嵌入模型深入

### 练习6.1：模型对比分析（基础）

**题目**：对比不同嵌入模型的性能

**要求**：
1. 使用sentence-transformers加载至少3个不同的嵌入模型（如BGE、E5、OpenAI）
2. 准备10个测试查询
3. 计算每个模型的检索质量（Hit Rate）
4. 对比模型的：
   - 向量维度
   - 检索速度
   - 检索质量
   - 内存占用

**提示**：
- 使用`sentence_transformers`库
- 可以使用固定的文档集进行测试
- Hit Rate = 相关文档在Top-10中的查询数 / 总查询数

**评分标准**：
- ⭐⭐⭐⭐⭐：完整对比+可视化分析
- ⭐⭐⭐⭐：完整对比
- ⭐⭐⭐：基本对比
- ⭐⭐：部分完成

---

### 练习6.2：模型微调实战（进阶）

**题目**：微调嵌入模型以提升特定领域的检索质量

**要求**：
1. 准备领域特定的训练数据（查询-正样本-负样本三元组）
2. 使用MultipleNegativesRankingLoss训练
3. 对比微调前后的Hit Rate和MRR
4. 分析微调效果

**提示**：
- 训练数据格式：[(query, positive_doc, negative_doc), ...]
- 使用sentence-transformers的训练接口
- 至少50个训练样本

**评分标准**：
- ⭐⭐⭐⭐⭐：完整微调+详细分析
- ⭐⭐⭐⭐：完成微调
- ⭐⭐⭐：基本流程

---

### 练习6.3：嵌入可视化（基础）

**题目**：使用t-SNE可视化嵌入向量

**要求**：
1. 对50个文档进行嵌入
2. 使用t-SNE降维到2D
3. 可视化展示，不同类别的文档用不同颜色
4. 分析聚类效果

**提示**：
- 使用sklearn.manifold.TSNE
- 使用matplotlib.pyplot绘图
- 可以用20个工程类+20个医学类+10个其他类文档

**评分标准**：
- ⭐⭐⭐⭐⭐：可视化+分析+交互
- ⭐⭐⭐⭐：清晰可视化
- ⭐⭐⭐：基本可视化

---

## 第7章：高级分块策略

### 练习7.1：分块策略对比（基础）

**题目**：对比5种分块策略的效果

**要求**：
1. 实现以下分块策略：
   - 固定长度分块
   - 语义分块
   - 递归分块
   - 父文档检索
   - 代码文档分块（如果适用）
2. 使用相同的文档集测试
3. 对比每种策略的：
   - 平均分块数
   - 检索Hit Rate
   - 平均响应时间
4. 给出推荐策略

**提示**：
- LlamaIndex提供了多种分块器
- 可以用相同数量（如100个）的文档测试
- 记录每次实验的数据

**评分标准**：
- ⭐⭐⭐⭐⭐：完整对比+推荐+实验
- ⭐⭐⭐⭐：完整对比
- ⭐⭐⭐：基本实现

---

### 练习7.2：最优分块大小实验（进阶）

**题目**：找到最优的分块大小参数

**要求**：
1. 固定其他参数，只改变chunk_size
2. 测试至少5个不同的chunk_size（如256, 384, 512, 768, 1024）
3. 绘制chunk_size vs Hit Rate曲线
4. 确定最优chunk_size

**提示**：
- 使用控制变量法
- 每个配置测试至少20个查询
- 用matplotlib绘制折线图

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实验+图表+分析
- ⭐⭐⭐⭐：完整实验
- ⭐⭐⭐：基本测试

---

### 练习7.3：自定义分块器（挑战）

**题目**：实现一个自适应分块器

**要求**：
1. 根据文档类型自动选择分块策略：
   - 技术文档 → 代码文档分块
   - 新闻文章 → 段落分块
   - 学术论文 → 语义分块
2. 实现自动类型检测
3. 测试至少3种类型文档
4. 评估效果

**提示**：
- 可以用关键词或结构检测文档类型
- 使用策略模式实现不同分块器
- 继承LlamaIndex的NodeParser

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+多类型测试
- ⭐⭐⭐⭐：基本实现
- ⭐⭐⭐：框架代码

---

## 第8章：查询增强技术

### 练习8.1：HyDE实现（基础）

**题目**：实现HyDE（假设文档嵌入）

**要求**：
1. 实现HyDE的完整流程：
   - 生成假设答案
   - 嵌入假设答案
   - 用假设答案检索
2. 对比使用HyDE前后的Hit Rate
3. 测试至少10个查询

**提示**：
- 需要LLM API生成假设答案
- 可以用GPT-3.5或本地模型
- 记录每次查询的假设答案

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+对比+分析
- ⭐⭐⭐⭐：完整实现
- ⭐⭐⭐：基本流程

---

### 练习8.2：查询重写系统（进阶）

**题目**：实现查询重写系统

**要求**：
1. 实现3种查询重写方法：
   - 同义词替换
   - 查询扩展
   - LLM重写
2. 对比重写前后的检索效果
3. 分析每种方法的适用场景

**提示**：
- 同义词替换：用WordNet或预定义词典
- 查询扩展：添加相关词
- LLM重写：让LLM优化查询表达

**评分标准**：
- ⭐⭐⭐⭐⭐：3种方法+完整对比
- ⭐⭐⭐⭐：2种方法+对比
- ⭐⭐⭐：1种方法

---

### 练习8.3：多查询策略（挑战）

**题目**：实现多查询检索策略

**要求**：
1. 从原始查询生成3-5个不同角度的查询
2. 对每个查询进行检索
3. 融合所有检索结果（去重、重排序）
4. 评估相比单查询的改进

**提示**：
- 可以用LLM生成不同角度的查询
- 使用RRF融合结果
- 对比单查询vs多查询的Hit Rate

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+详细评估
- ⭐⭐⭐⭐：基本实现
- ⭐⭐⭐：框架代码

---

## 第9章：混合检索与重排序

### 练习9.1：RRF算法实现（基础）

**题目**：从零实现RRF融合算法

**要求**：
1. 不使用现成库，手动实现RRF
2. 支持可配置的k参数
3. 支持加权融合
4. 测试并验证正确性

**提示**：
- 公式：RRF(q,d) = Σ 1/(k+rank_i)
- 先处理两个检索器，再扩展到多个
- 用单元测试验证

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+测试+扩展
- ⭐⭐⭐⭐：完整实现+测试
- ⭐⭐⭐：基本实现

---

### 练习9.2：混合检索系统（进阶）

**题目**：构建完整的混合检索系统

**要求**：
1. 集成向量检索和BM25检索
2. 实现RRF融合
3. 添加CrossEncoder重排序
4. 评估四阶段效果：
   - 仅向量
   - 仅BM25
   - 混合检索
   - 混合+重排序

**提示**：
- 使用rank_bm25实现BM25
- 可以用sentence-transformers的CrossEncoder
- 至少测试50个查询

**评分标准**：
- ⭐⭐⭐⭐⭐：完整系统+详细评估
- ⭐⭐⭐⭐：基本系统
- ⭐⭐⭐：框架代码

---

### 练习9.3：动态权重优化（挑战）

**题目**：实现动态权重调整机制

**要求**：
1. 根据查询特征动态调整向量/BM25权重
2. 考虑因素：
   - 查询长度
   - 是否包含专有名词
   - 查询类型（事实性/概念性）
3. 对比固定权重vs动态权重

**提示**：
- 设计规则或用ML模型预测最优权重
- 用验证集选择规则
- A/B测试验证效果

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+验证
- ⭐⭐⭐⭐：基本实现
- ⭐⭐⭐：规则定义

---

## 第10章：高级RAG模式

### 练习10.1：迭代检索实现（基础）

**题目**：实现迭代检索系统

**要求**：
1. 最多3轮迭代
2. 每轮后判断是否继续
3. 基于LLM生成下一轮查询
4. 测试多跳推理问题

**提示**：
- 需要LLM API判断信息完整度
- 可以设置最大迭代次数限制
- 测试案例需要多跳推理

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+测试案例
- ⭐⭐⭐⭐：基本实现
- ⭐⭐⭐：框架代码

---

### 练习10.2：自适应RAG（进阶）

**题目**：构建自适应检索系统

**要求**：
1. 实现查询复杂度分析器
2. 根据复杂度选择检索策略：
   - 简单查询 → 直接检索
   - 中等查询 → 混合检索
   - 复杂查询 → 迭代检索
3. 评估自适应vs固定策略

**提示**：
- 定义查询特征（长度、实体、问题词等）
- 可以用规则或ML模型分类
- 对比响应时间和质量

**评分标准**：
- ⭐⭐⭐⭐⭐：完整系统+评估
- ⭐⭐⭐⭐：基本系统
- ⭐⭐⭐：分类器

---

### 练习10.3：元数据过滤应用（基础）

**题目**：为文档添加元数据并实现过滤

**要求**：
1. 为文档添加丰富的元数据（日期、类别、难度等）
2. 实现5种过滤条件的组合查询
3. 评估过滤对检索精度的影响
4. 提供使用示例

**提示**：
- Chroma支持元数据过滤
- 实现比较操作符：>, <, >=, <=, in
- 测试复杂过滤条件

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+多种条件
- ⭐⭐⭐⭐：基本实现
- ⭐⭐⭐：简单过滤

---

## 第11章：性能优化

### 练习11.1：多层缓存实现（基础）

**题目**：实现L1+L2双层缓存

**要求**：
1. L1：内存缓存（LRU，最多1000条）
2. L2：Redis缓存（可选，或用文件模拟）
3. 实现缓存穿透、击穿、雪崩防护
4. 测试缓存命中率

**提示**：
- L1可以用OrderedDict实现LRU
- 缓存Key用query的hash
- 记录缓存统计信息

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+防护机制
- ⭐⭐⭐⭐：基本实现
- ⭐⭐⭐：单层缓存

---

### 练习11.2：批处理优化（进阶）

**题目**：优化批量查询性能

**要求**：
1. 实现批量查询接口
2. 支持并发处理
3. 对比顺序处理vs批处理
4. 目标：3x以上加速

**提示**：
- 使用ThreadPoolExecutor或ProcessPoolExecutor
- 批量嵌入可以一次调用模型
- 记录处理时间

**评分标准**：
- ⭐⭐⭐⭐⭐：完整实现+3x加速
- ⭐⭐⭐⭐：基本实现+2x加速
- ⭐⭐⭐：批处理接口

---

### 练习11.3：内存优化（挑战）

**题目**：优化大文档集的内存使用

**要求**：
1. 使用生成器按需加载文档
2. 实现向量量化（float32 → float16）
3. 限制上下文历史长度
4. 对比优化前后的内存占用

**提示**：
- 使用memory_profiler分析内存
- 向量量化可节省50%内存
- 上下文窗口设为固定大小

**评分标准**：
- ⭐⭐⭐⭐⭐：完整优化+50%节省
- ⭐⭐⭐⭐：部分优化
- ⭐⭐⭐：框架代码

---

## 第12章：综合项目优化

### 综合项目1：InteliKB v2.0完整实现

**项目描述**：完整实现InteliKB v2.0系统

**功能需求**：
1. ✅ 高质量嵌入模型（BGE或E5）
2. ✅ 语义分块策略
3. ✅ 混合检索（向量+BM25+RRF）
4. ✅ CrossEncoder重排序
5. ✅ 多层缓存
6. ✅ 性能监控
7. ✅ A/B测试框架

**性能目标**：
- Hit Rate > 0.80
- MRR > 0.70
- P95延迟 < 1000ms
- 缓存命中率 > 60%

**交付内容**：
1. 完整代码（单个Python文件或模块）
2. 配置文件
3. 测试脚本
4. 性能报告
5. 使用文档

**评分标准**（总分100分）：
- 功能完整性：40分
- 代码质量：25分
- 性能表现：25分
- 文档说明：10分

---

### 综合项目2：RAG系统评估框架

**项目描述**：构建完整的RAG评估系统

**功能需求**：
1. 支持多种评估指标（Hit Rate、MRR、Precision、Recall）
2. 自动化测试流程
3. 可视化评估结果
4. 对比不同RAG版本
5. 生成评估报告

**交付内容**：
1. 评估框架代码
2. 测试数据集（至少100个查询）
3. 评估报告模板
4. 使用示例

**评分标准**（总分100分）：
- 指标全面性：30分
- 自动化程度：25分
- 可视化质量：20分
- 易用性：15分
- 文档完整性：10分

---

### 综合项目3：生产级RAG API服务

**项目描述**：将RAG系统部署为REST API

**功能需求**：
1. FastAPI或Flask实现
2. 查询接口
3. 批量查询接口
4. 健康检查接口
5. 速率限制
6. 日志记录
7. 错误处理

**性能目标**：
- 支持50 QPS
- P95延迟 < 500ms
- 99.9%可用性

**交付内容**：
1. API代码
2. Docker配置
3. 部署文档
4. API文档（Swagger）

**评分标准**（总分100分）：
- 功能完整性：30分
- 性能表现：30分
- 代码质量：20分
- 部署配置：10分
- 文档质量：10分

---

### 综合项目4：RAG系统监控平台

**项目描述**：构建实时监控Dashboard

**功能需求**：
1. 实时性能指标（QPS、延迟、缓存命中率）
2. 查询分布可视化
3. 错误追踪
4. 告警机制
5. 历史数据趋势

**技术栈建议**：
- 后端：Prometheus + Grafana
- 或：自定义Dashboard（Plotly Dash）

**交付内容**：
1. 监控系统代码
2. Dashboard配置
3. 告警规则
4. 使用文档

**评分标准**（总分100分）：
- 功能丰富度：35分
- 可视化效果：25分
- 实时性：20分
- 易用性：10分
- 文档质量：10分

---

### 综合项目5：RAG最佳实践总结

**项目描述**：基于实践撰写最佳实践文档

**内容要求**：
1. 数据准备最佳实践
2. 模型选择指南
3. 分块策略建议
4. 检索优化技巧
5. 性能优化方法
6. 常见陷阱及解决方案
7. 生产部署checklist
8. 案例研究（2-3个）

**格式要求**：
- Markdown格式
- 包含代码示例
- 配图表说明
- 总字数 > 5000字

**评分标准**（总分100分）：
- 内容全面性：30分
- 实用价值：30分
- 结构清晰度：20分
- 示例质量：10分
- 可读性：10分

---

## 📊 练习完成检查表

使用此检查表跟踪你的进度：

### 第6章：嵌入模型
- [ ] 练习6.1：模型对比分析
- [ ] 练习6.2：模型微调实战
- [ ] 练习6.3：嵌入可视化

### 第7章：分块策略
- [ ] 练习7.1：分块策略对比
- [ ] 练习7.2：最优分块大小实验
- [ ] 练习7.3：自定义分块器

### 第8章：查询增强
- [ ] 练习8.1：HyDE实现
- [ ] 练习8.2：查询重写系统
- [ ] 练习8.3：多查询策略

### 第9章：混合检索
- [ ] 练习9.1：RRF算法实现
- [ ] 练习9.2：混合检索系统
- [ ] 练习9.3：动态权重优化

### 第10章：高级RAG模式
- [ ] 练习10.1：迭代检索实现
- [ ] 练习10.2：自适应RAG
- [ ] 练习10.3：元数据过滤应用

### 第11章：性能优化
- [ ] 练习11.1：多层缓存实现
- [ ] 练习11.2：批处理优化
- [ ] 练习11.3：内存优化

### 第12章：综合项目
- [ ] 项目1：InteliKB v2.0
- [ ] 项目2：评估框架
- [ ] 项目3：API服务
- [ ] 项目4：监控平台
- [ ] 项目5：最佳实践文档

---

## 💡 学习建议

### 如何有效完成练习

**1. 理论先行**
- 先完成章节学习
- 理解核心概念
- 运行章节示例代码

**2. 循序渐进**
- 从基础练习开始
- 逐步挑战进阶题目
- 最后攻克综合项目

**3. 动手实践**
- 每道题都要亲手写代码
- 不要只看不练
- 遇到问题及时查资料

**4. 记录总结**
- 记录解决方案
- 总结经验教训
- 分享学习心得

**5. 寻求反馈**
- 参考参考答案
- 对比不同实现
- 持续改进优化

---

## 🎯 练习目标

完成这些练习后，你将能够：

✅ 独立实现优化的RAG系统
✅ 掌握10+种优化技术
✅ 能够进行性能评估和调优
✅ 具备生产级开发能力
✅ 拥有完整的项目经验

---

**祝学习顺利！加油！** 🚀

---

> 需要参考答案或有疑问？欢迎查看每个章节的详细解答，或在GitHub提交Issue！
