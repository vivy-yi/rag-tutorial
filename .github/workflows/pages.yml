name: Deploy Jupyter Notebooks to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install jupyter
          pip install nbconvert
          pip install mkdocs-material
          pip install mkdocs-jupyter
          pip install markdown

      - name: Convert Notebooks to Markdown
        run: |
          # åˆ›å»ºæ–‡æ¡£ç›®å½•
          mkdir -p site/notebooks

          # è½¬æ¢æ‰€æœ‰notebooks
          for notebook in $(find . -name "*.ipynb" -not -path "./.ipynb_checkpoints/*"); do
            echo "Converting $notebook"
            jupyter nbconvert --to markdown "$notebook" --output-dir site/notebooks/
          done

      - name: Create index page
        run: |
          cat > site/index.md << 'EOF'
          # RAGå®Œæ•´æ•™ç¨‹ - Jupyter Notebooks

          æ¬¢è¿æ¥åˆ°RAGå®Œæ•´æ•™ç¨‹çš„Jupyter Notebookåœ¨çº¿é¢„è§ˆï¼

          ## ğŸ“š Notebookåˆ—è¡¨

          ### æ¨¡å—1ï¼šåŸºç¡€å…¥é—¨

          - [01 - RAGæ ¸å¿ƒæ¦‚å¿µ](notebooks/01_rag_concepts.md)
          - [02 - ç¯å¢ƒæ­å»º](notebooks/02_environment_setup.md)
          - [03 - åŸºç¡€RAGå®ç°](notebooks/03_basic_rag_implementation.md)
          - [04 - RAGè¯„ä¼°](notebooks/04_rag_evaluation.md)

          ### æ¨¡å—2ï¼šæ ¸å¿ƒä¼˜åŒ–

          - [06 - åµŒå…¥æ¨¡å‹æ·±å…¥](notebooks/06_embedding_models.md)
          - [07 - é«˜çº§åˆ†å—ç­–ç•¥](notebooks/07_advanced_chunking.md)
          - [08 - æŸ¥è¯¢å¢å¼ºæŠ€æœ¯](notebooks/08_query_enhancement.md)
          - [09 - æ··åˆæ£€ç´¢](notebooks/09_hybrid_retrieval.md)
          - [10 - é«˜çº§RAGæ¨¡å¼](notebooks/10_advanced_rag_patterns.md)
          - [11 - æ€§èƒ½ä¼˜åŒ–](notebooks/11_performance_optimization.md)
          - [12 - ç»¼åˆä¼˜åŒ–](notebooks/12_comprehensive_optimization.md)
          - [13 - æ£€ç´¢å‹ç¼©](notebooks/13_retrieval_compression.md)

          ### æ¨¡å—3ï¼šé«˜çº§æ¶æ„

          - [13 - ReAct Agent](notebooks/13_react_agent.md)
          - [14 - é«˜çº§Agentæ¨¡å¼](notebooks/14_advanced_agents.md)
          - [14 - Deep Research](notebooks/14_deep_research_agent.md)
          - [15 - GraphRAG](notebooks/15_graph_rag.md)
          - [16 - å¤šæ¨¡æ€RAG](notebooks/16_multimodal_rag.md)

          ---

          **ğŸ’¡ æç¤º**: è¿™äº›æ˜¯Jupyter Notebookè½¬æ¢åçš„Markdownç‰ˆæœ¬ã€‚
          æƒ³è¦äº¤äº’å¼è¿è¡Œï¼Œè¯·å…‹éš†ä»“åº“åˆ°æœ¬åœ°ï¼š
          ```bash
          git clone https://github.com/vivy-yi/rag-tutorial.git
          cd rag-tutorial
          pip install -r requirements.txt
          jupyter notebook
          ```
          EOF

      - name: Create HTML index page
        run: |
          cat > site/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>RAGå®Œæ•´æ•™ç¨‹ - Jupyter Notebooks</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                      line-height: 1.6;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f6f8fa;
                  }
                  .container {
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #0366d6;
                      border-bottom: 2px solid #e1e4e8;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #24292e;
                      margin-top: 30px;
                  }
                  ul {
                      list-style: none;
                      padding-left: 0;
                  }
                  li {
                      padding: 8px 0;
                      border-bottom: 1px solid #e1e4e8;
                  }
                  li:last-child {
                      border-bottom: none;
                  }
                  a {
                      color: #0366d6;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .emoji {
                      font-size: 1.2em;
                  }
                  .tip {
                      background: #f6f8fa;
                      border-left: 4px solid #0366d6;
                      padding: 15px;
                      margin-top: 30px;
                      border-radius: 4px;
                  }
                  .tip code {
                      background: #f6f8fa;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1><span class="emoji">ğŸš€</span> RAGå®Œæ•´æ•™ç¨‹ - Jupyter Notebooks</h1>
                  <p>æ¬¢è¿æ¥åˆ°RAGå®Œæ•´æ•™ç¨‹çš„Jupyter Notebookåœ¨çº¿é¢„è§ˆï¼</p>

                  <h2><span class="emoji">ğŸ“š</span> Notebookåˆ—è¡¨</h2>

                  <h3>æ¨¡å—1ï¼šåŸºç¡€å…¥é—¨</h3>
                  <ul>
                      <li><a href="notebooks/01_rag_concepts.md">01 - RAGæ ¸å¿ƒæ¦‚å¿µ</a></li>
                      <li><a href="notebooks/02_environment_setup.md">02 - ç¯å¢ƒæ­å»º</a></li>
                      <li><a href="notebooks/03_basic_rag_implementation.md">03 - åŸºç¡€RAGå®ç°</a></li>
                      <li><a href="notebooks/04_rag_evaluation.md">04 - RAGè¯„ä¼°</a></li>
                  </ul>

                  <h3>æ¨¡å—2ï¼šæ ¸å¿ƒä¼˜åŒ–</h3>
                  <ul>
                      <li><a href="notebooks/06_embedding_models.md">06 - åµŒå…¥æ¨¡å‹æ·±å…¥</a></li>
                      <li><a href="notebooks/07_advanced_chunking.md">07 - é«˜çº§åˆ†å—ç­–ç•¥</a></li>
                      <li><a href="notebooks/08_query_enhancement.md">08 - æŸ¥è¯¢å¢å¼ºæŠ€æœ¯</a></li>
                      <li><a href="notebooks/09_hybrid_retrieval.md">09 - æ··åˆæ£€ç´¢</a></li>
                      <li><a href="notebooks/10_advanced_rag_patterns.md">10 - é«˜çº§RAGæ¨¡å¼</a></li>
                      <li><a href="notebooks/11_performance_optimization.md">11 - æ€§èƒ½ä¼˜åŒ–</a></li>
                      <li><a href="notebooks/12_comprehensive_optimization.md">12 - ç»¼åˆä¼˜åŒ–</a></li>
                      <li><a href="notebooks/13_retrieval_compression.md">13 - æ£€ç´¢å‹ç¼©</a></li>
                  </ul>

                  <h3>æ¨¡å—3ï¼šé«˜çº§æ¶æ„</h3>
                  <ul>
                      <li><a href="notebooks/13_react_agent.md">13 - ReAct Agent</a></li>
                      <li><a href="notebooks/14_advanced_agents.md">14 - é«˜çº§Agentæ¨¡å¼</a></li>
                      <li><a href="notebooks/14_deep_research_agent.md">14 - Deep Research</a></li>
                      <li><a href="notebooks/15_graph_rag.md">15 - GraphRAG</a></li>
                      <li><a href="notebooks/16_multimodal_rag.md">16 - å¤šæ¨¡æ€RAG</a></li>
                  </ul>

                  <div class="tip">
                      <strong><span class="emoji">ğŸ’¡</span> æç¤º</strong>: è¿™äº›æ˜¯Jupyter Notebookè½¬æ¢åçš„Markdownç‰ˆæœ¬ã€‚<br>
                      æƒ³è¦äº¤äº’å¼è¿è¡Œï¼Œè¯·å…‹éš†ä»“åº“åˆ°æœ¬åœ°ï¼š<br>
                      <code>git clone https://github.com/vivy-yi/rag-tutorial.git</code><br>
                      <code>cd rag-tutorial</code><br>
                      <code>pip install -r requirements.txt</code><br>
                      <code>jupyter notebook</code>
                  </div>
              </div>
          </body>
          </html>
          HTMLEOF

      - name: Copy to docs directory (compatibility)
        run: |
          # åŒæ—¶å¤åˆ¶åˆ°/docsç›®å½•ï¼Œå…¼å®¹GitHub Pagesçš„sourceé…ç½®
          mkdir -p docs
          cp -r site/* docs/
          echo "âœ“ å·²å¤åˆ¶åˆ°docsç›®å½•"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
